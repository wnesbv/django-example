{% extends "base.html" %}
{% block title %} chat room {% endblock %}

{% block content %}


<form method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    <sup>message</sup>
    <input id="message-input" type="text" size="200" class="form-control my-4">
    <input id="btn-submit" type="button" value="Send">
</form>

<ul id="chat"></ul>

<ul class="list-group list-group-flush flex-wrap">
    {% if msg_list %}
    {% for i in  msg_list %}

    <li class="list-group-item"><sup>id</sup> {{ i.id }}</li>
    <li class="list-group-item my-2">
        <span><sup class="d-block">nick</sup> ({{ i.nick }})</span>
        <span><sup class="d-block mt-4">remark</sup> ({{ i.remark }})</span>
        <span><sup class="d-block mt-4">created_at</sup> {{ i.created_at }}</span>
    </li>

    {% endfor %}
    {% endif %}
</ul>


<script>

let chat = document.querySelector("#chat")
let input = document.querySelector("#message-input")
let btnSubmit = document.querySelector("#btn-submit")
 
const ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
const websocket_str = `${ws_scheme}://${window.location.host}/ws/chat/{{ user_id }}`;

const webSocket = new WebSocket(websocket_str);
 
webSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    chat.innerHTML += "<li>" + data.message + "</li>" + "<li>" + data.nick + "</li>" + "<li>" + data.created_at + "</li>"
};

 
btnSubmit.addEventListener("click", () => {
    message = input.value;
    webSocket.send(JSON.stringify({
        "message": message
    }));
    input.value = "";
})

</script>


{% endblock %}